#!/usr/bin/env python3
"""
Test suite for verifying docstring script idempotency.

This test ensures that running add_docstrings.py multiple times on the same
codebase produces identical results (no duplicate docstrings, no changes on
subsequent runs).
"""

import os
import tempfile
import shutil
from pathlib import Path
import sys

# Add parent directory to path so we can import add_docstrings
sys.path.insert(0, str(Path(__file__).parent))

from add_docstrings import add_docstring_to_file, remove_autogenerated_docstring, has_docstring


def test_idempotency_simple_function():
    """Test that running docstring generation twice produces identical output."""
    
    simple_func = '''function out = simple_test(in1, in2)

out = in1 + in2;

end
'''
    
    with tempfile.NamedTemporaryFile(mode='w', suffix='.m', delete=False) as f:
        f.write(simple_func)
        f.flush()
        filepath = f.name
    
    try:
        # First run
        result1, msg1 = add_docstring_to_file(filepath)
        assert result1, f"First run failed: {msg1}"
        
        with open(filepath, 'r') as f:
            content_after_first = f.read()
        
        # Second run (should produce identical content)
        result2, msg2 = add_docstring_to_file(filepath)
        
        with open(filepath, 'r') as f:
            content_after_second = f.read()
        
        # Content should be identical after second run
        assert content_after_first == content_after_second, \
            f"Content changed after second run!\nFirst:\n{content_after_first}\n\nSecond:\n{content_after_second}"
        
        # Verify no duplicate docstrings
        docstring_count = content_after_second.count('%[AUTOGENERATED]')
        assert docstring_count == 1, f"Expected 1 autogenerated marker, found {docstring_count}"
        
        print("✓ test_idempotency_simple_function PASSED")
        return True
    
    finally:
        os.unlink(filepath)


def test_remove_duplicate_docstrings():
    """Test that duplicate docstrings (autogenerated + manual) are properly removed."""
    
    # File with duplicate docstring - autogenerated marker + both docstrings
    duplicate_docstring = '''%[AUTOGENERATED]
function out = test_dup(in1)
% Function test_dup
%
% :param in1: Input parameter
% :returns: Output value
% This is the original manual documentation
% It should be preserved in spirit but removed as duplicate
out = in1 * 2;
end
'''
    
    with tempfile.NamedTemporaryFile(mode='w', suffix='.m', delete=False) as f:
        f.write(duplicate_docstring)
        f.flush()
        filepath = f.name
    
    try:
        # Run once
        result1, msg1 = add_docstring_to_file(filepath)
        assert result1, f"First run failed: {msg1}"
        
        with open(filepath, 'r') as f:
            content_after_first = f.read()
        
        # Count docstring lines (lines with :param or :returns)
        doc_lines_first = [l for l in content_after_first.split('\n') if ':param' in l or ':returns' in l]
        
        # Run again
        result2, msg2 = add_docstring_to_file(filepath)
        
        with open(filepath, 'r') as f:
            content_after_second = f.read()
        
        # Count docstring lines again
        doc_lines_second = [l for l in content_after_second.split('\n') if ':param' in l or ':returns' in l]
        
        # Should have exactly the same docstring lines (no duplicates)
        assert doc_lines_first == doc_lines_second, \
            f"Docstring lines differ!\nFirst run:\n{doc_lines_first}\n\nSecond run:\n{doc_lines_second}"
        
        # Verify no duplicate markers
        markers = content_after_second.count('%[AUTOGENERATED]')
        assert markers == 1, f"Expected 1 autogenerated marker, found {markers}"
        
        print("✓ test_remove_duplicate_docstrings PASSED")
        return True
    
    finally:
        os.unlink(filepath)


def test_remove_autogenerated_docstring_function():
    """Test the remove_autogenerated_docstring function directly."""
    
    content_with_dup = '''%[AUTOGENERATED]
function out = test()
% Function test
%
% :param x: Some param
% :returns: Some return
% Extra manual documentation here
% that should be preserved
out = 42;
end
'''
    
    cleaned = remove_autogenerated_docstring(content_with_dup)
    
    # Should remove autogenerated docstring lines but preserve manual docs
    lines = cleaned.split('\n')
    
    # Should not have the autogenerated marker
    assert '%[AUTOGENERATED]' not in cleaned, "Still has autogenerated marker"
    
    # Should not have % Function or % :param or % :returns lines
    assert '% Function' not in cleaned, "Still has '% Function' line"
    assert ':param' not in cleaned, "Still has ':param' line"
    assert ':returns' not in cleaned, "Still has ':returns' line"
    
    # But SHOULD have the manual documentation
    assert 'Extra manual documentation here' in cleaned, "Lost manual documentation!"
    assert 'that should be preserved' in cleaned, "Lost manual documentation!"
    
    # Should have the function and code
    assert 'function out = test()' in cleaned, "Lost function signature"
    assert 'out = 42;' in cleaned, "Lost function body"
    
    print("✓ test_remove_autogenerated_docstring_function PASSED")
    return True


def test_has_docstring_with_autogenerated_marker():
    """Test that autogenerated marker indicates docstring should be replaced."""
    
    content_with_marker = '''%[AUTOGENERATED]
function out = test()
% Function test
% Old docstring
out = 42;
end
'''
    
    has_manual, has_autogen = has_docstring(content_with_marker)
    
    # Should indicate autogenerated exists but no manual
    assert has_autogen == True, "Should detect autogenerated marker"
    assert has_manual == False, "Should not treat autogenerated as manual"
    
    print("✓ test_has_docstring_with_autogenerated_marker PASSED")
    return True


def test_integration_duplicate_removal():
    """Integration test: multiple runs should not create or preserve duplicates."""
    
    original = '''function [out1, out2] = multi_out(in1, in2, in3)

% Some comment
out1 = in1 + in2;
out2 = in2 * in3;

end
'''
    
    with tempfile.NamedTemporaryFile(mode='w', suffix='.m', delete=False) as f:
        f.write(original)
        f.flush()
        filepath = f.name
    
    try:
        # Run 3 times and collect results
        contents = []
        
        for run_num in range(1, 4):
            result, msg = add_docstring_to_file(filepath)
            
            with open(filepath, 'r') as f:
                content = f.read()
            
            contents.append(content)
            
            # Verify no duplicate markers
            marker_count = content.count('%[AUTOGENERATED]')
            assert marker_count <= 1, f"Run {run_num}: Found {marker_count} markers (expected 0 or 1)"
            
            # Verify docstring integrity
            lines = content.split('\n')
            param_lines = [l for l in lines if ':param' in l]
            return_lines = [l for l in lines if ':returns' in l]
            
            expected_params = 3  # in1, in2, in3
            expected_returns = 2  # out1, out2
            
            assert len(param_lines) == expected_params, \
                f"Run {run_num}: Expected {expected_params} param lines, got {len(param_lines)}"
            assert len(return_lines) == expected_returns, \
                f"Run {run_num}: Expected {expected_returns} return lines, got {len(return_lines)}"
        
        # All three runs should produce identical content
        assert contents[0] == contents[1], "Run 1 and 2 produced different content"
        assert contents[1] == contents[2], "Run 2 and 3 produced different content"
        
        print("✓ test_integration_duplicate_removal PASSED")
        return True
    
    finally:
        os.unlink(filepath)


def run_all_tests():
    """Run all tests and report results."""
    
    tests = [
        test_idempotency_simple_function,
        test_remove_duplicate_docstrings,
        test_remove_autogenerated_docstring_function,
        test_has_docstring_with_autogenerated_marker,
        test_integration_duplicate_removal,
    ]
    
    print("="*60)
    print("Running Docstring Idempotency Tests")
    print("="*60 + "\n")
    
    passed = 0
    failed = 0
    
    for test in tests:
        try:
            if test():
                passed += 1
        except AssertionError as e:
            print(f"✗ {test.__name__} FAILED: {e}\n")
            failed += 1
        except Exception as e:
            print(f"✗ {test.__name__} ERROR: {e}\n")
            failed += 1
    
    print("="*60)
    print(f"Results: {passed} passed, {failed} failed")
    print("="*60)
    
    return failed == 0


if __name__ == '__main__':
    success = run_all_tests()
    sys.exit(0 if success else 1)
